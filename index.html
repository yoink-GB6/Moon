<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>æ¬¢è¿æ¬¢è¿~</title>

<!-- â˜… å¡«å…¥ä½ çš„ Supabase é…ç½® â˜… -->
<script>
  window.SUPABASE_URL  = 'https://hrgottdtlnihablruxtr.supabase.co';
  window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyZ290dGR0bG5paGFibHJ1eHRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMTcxOTAsImV4cCI6MjA4Njg5MzE5MH0.6Ng0E96W8VLnATqWgc_o7xVKCrzlewn0J-ba2ChpcE4';
  window.EDIT_PASSWORD = 'pgzjtfslm';
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å…¨å±€å˜é‡ & é‡ç½®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#0f1117;--panel:#1a1d2e;--border:#2d3048;
  --accent:#7c83f7;--green:#27ae60;--red:#e74c3c;--amber:#f39c12;
  --ib:#252840;--ibr:#3d4166;--text:#e8eaed;--muted:#667788;
  --sidebar-w:220px;
  --topbar-h:50px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   App shell
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:flex;height:100%;flex-direction:column}

/* â”€â”€ Topbar â”€â”€ */
#topbar{
  display:flex;align-items:center;gap:10px;
  padding:0 14px;height:var(--topbar-h);
  background:var(--panel);border-bottom:1px solid var(--border);
  flex-shrink:0;z-index:100;
}
#topbar-title{font-size:15px;font-weight:700;color:var(--accent);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#sync-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0;transition:background .3s}
#sync-dot.syncing{background:var(--amber);animation:pulse .8s infinite}
#sync-dot.ok{background:var(--green)}
#sync-dot.err{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
#lock-btn{
  background:none;border:1px solid var(--ibr);color:var(--muted);
  border-radius:7px;padding:5px 10px;cursor:pointer;font-size:13px;
  flex-shrink:0;transition:all .2s;white-space:nowrap;
}
#lock-btn.unlocked{color:var(--green);border-color:var(--green)}
#lock-btn:hover{border-color:var(--accent);color:var(--accent)}
#menu-btn{
  display:none;background:none;border:none;color:var(--accent);
  font-size:22px;cursor:pointer;padding:4px;line-height:1;flex-shrink:0;
}

/* â”€â”€ Body row â”€â”€ */
#body-row{display:flex;flex:1;overflow:hidden;position:relative}

/* â”€â”€ Left sidebar â”€â”€ */
#sidebar{
  position:absolute;left:0;top:0;bottom:0;z-index:100;
  width:var(--sidebar-w);background:var(--panel);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
  transition:transform .28s cubic-bezier(0.4,0,0.2,1);
}
#sidebar.collapsed{transform:translateX(-100%);}
#sidebar-logo{
  padding:12px 14px 10px;display:flex;align-items:flex-start;gap:8px;
  font-size:18px;font-weight:800;color:var(--accent);
  border-bottom:1px solid var(--border);
  letter-spacing:.5px;user-select:none;
}

#sidebar-nav{flex:1;overflow-y:auto;padding:8px 0}
#sidebar-nav::-webkit-scrollbar{width:2px}
#sidebar-nav::-webkit-scrollbar-thumb{background:var(--ibr);border-radius:2px}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 16px;cursor:pointer;font-size:14px;color:#99a;
  border-left:3px solid transparent;transition:all .15s;
  user-select:none;
}
.nav-item:hover{background:#22263a;color:#ccd}
.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:rgba(124,131,247,.08)}
.nav-item .nav-icon{font-size:16px;flex-shrink:0;width:20px;text-align:center}
.nav-item .nav-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#sidebar-footer{
  padding:10px 16px;font-size:11px;color:var(--muted);
  border-top:1px solid var(--border);line-height:1.8;
}


/* Floating expand buttons (when panels are collapsed) */
.expand-btn-float{
  position:fixed;display:flex;align-items:center;justify-content:center;
  width:36px;height:36px;border-radius:50%;
  background:var(--panel);border:1px solid var(--accent);
  color:var(--accent);font-size:16px;cursor:pointer;
  box-shadow:0 4px 16px rgba(0,0,0,.5);z-index:200;
  transition:all .2s;opacity:0;pointer-events:none;  /* Hidden via opacity, JS will toggle */
}
.expand-btn-float.show{opacity:1;pointer-events:auto;}
.expand-btn-float:hover{background:var(--accent);color:#fff;transform:scale(1.1)}
#sidebar-expand{top:50%;left:8px;transform:translateY(-50%)}
#tl-expand{top:50%;right:8px;transform:translateY(-50%)}
#map-expand{top:50%;right:8px;transform:translateY(-50%)}

.panel-toggle-btn{
  background:none;border:1px solid var(--ibr);color:var(--muted);
  border-radius:6px;padding:4px 7px;cursor:pointer;font-size:13px;
  transition:all .15s;flex-shrink:0;line-height:1;
}
.panel-toggle-btn:hover{color:var(--accent);border-color:var(--accent)}

/* â”€â”€ Main content area â”€â”€ */
#main-content{
  flex:1;overflow:hidden;display:flex;flex-direction:column;position:relative;
  background:radial-gradient(ellipse at 20% 40%,rgba(124,131,247,.05) 0%,transparent 60%),var(--bg);
}

/* â”€â”€ Sidebar overlay (mobile) â”€â”€ */
#sidebar-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
  z-index:199;opacity:0;transition:opacity .3s;
}
#sidebar-overlay.show{display:block;opacity:1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Shared component styles
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{
  padding:7px 13px;border-radius:7px;border:none;cursor:pointer;
  font-size:13px;font-weight:600;white-space:nowrap;
  transition:filter .15s,transform .1s;touch-action:manipulation;
}
.btn:active{transform:scale(.94);filter:brightness(.85)}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.bp{background:var(--accent);color:#fff}
.be{background:var(--green);color:#fff}
.bn{background:#383b55;color:#bbb}
.br{background:var(--red);color:#fff}

input[type=text],input[type=number],input[type=password],textarea{
  background:var(--ib);border:1px solid var(--ibr);color:var(--text);
  border-radius:7px;padding:8px 11px;font-size:14px;outline:none;width:100%;
  transition:border-color .2s;-webkit-appearance:none;resize:vertical;
}
input:focus,textarea:focus{border-color:var(--accent)}

.ctrl-label{font-size:11px;color:var(--accent);font-weight:600;margin-bottom:7px;letter-spacing:.4px}
.ctrl-note{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5}
.small-btn{
  font-size:11px;padding:4px 9px;border-radius:5px;
  border:1px solid var(--ibr);background:transparent;color:var(--muted);
  cursor:pointer;touch-action:manipulation;white-space:nowrap;
}
.small-btn:active{color:var(--accent);border-color:var(--accent)}
.mbtns{display:flex;gap:10px;margin-top:8px}
.mbtns .btn{padding:10px 16px;font-size:14px}

/* â”€â”€ Toast â”€â”€ */
#toast{
  position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(40px);
  background:#252840;border:1px solid #4a52a0;color:#c8caff;
  padding:9px 20px;border-radius:20px;font-size:13px;z-index:3000;
  transition:transform .25s ease,opacity .25s;opacity:0;pointer-events:none;white-space:nowrap;
}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* â”€â”€ Readonly banner â”€â”€ */
#readonly-banner{
  display:none;background:rgba(124,131,247,.08);border-bottom:1px solid rgba(124,131,247,.18);
  padding:5px 16px;font-size:12px;color:var(--muted);text-align:center;flex-shrink:0;
}
#readonly-banner.show{display:block}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Password modal
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#pw-modal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);
  z-index:1000;align-items:center;justify-content:center;
}
#pw-modal.show{display:flex}
#pw-box{
  background:var(--panel);border:1px solid var(--ibr);border-radius:14px;
  padding:28px;width:320px;box-shadow:0 16px 48px rgba(0,0,0,.6);
}
#pw-box h2{font-size:16px;margin-bottom:16px;color:var(--accent)}
#pw-error{color:var(--red);font-size:12px;margin-top:-8px;margin-bottom:8px;display:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME PAGE styles
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-home{padding:32px;max-width:720px;overflow-y:auto;height:100%}
.home-header{display:flex;align-items:center;gap:10px;margin-bottom:20px}
.home-title-view{font-size:26px;font-weight:800;color:var(--text);flex:1}
.home-body-wrap{margin-bottom:28px;position:relative}
.home-body-view p{color:#aab;line-height:1.85;font-size:15px;margin-bottom:.5em}
.home-placeholder{color:var(--muted)!important;font-style:italic}
.home-links-section{margin-bottom:28px}
.home-links-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.home-links-header h3{font-size:14px;font-weight:700;color:var(--accent)}
.link-item{
  display:flex;align-items:center;gap:10px;padding:9px 12px;
  background:var(--ib);border:1px solid var(--ibr);border-radius:8px;margin-bottom:6px;
}
.link-item a{color:var(--accent);font-size:14px;font-weight:600;text-decoration:none;flex:1}
.link-item a:hover{text-decoration:underline}
.link-url-preview{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px}
.link-delete-btn{padding:3px 8px;font-size:12px}
.edit-inline-btn{
  background:none;border:1px solid var(--ibr);color:var(--muted);
  border-radius:6px;padding:4px 9px;cursor:pointer;font-size:12px;
  transition:all .15s;white-space:nowrap;
}
.edit-inline-btn:hover{color:var(--accent);border-color:var(--accent)}
.inline-editor{margin-bottom:12px}
.inline-editor input,.inline-editor textarea{margin-bottom:8px;font-size:15px}
.inline-editor-btns{display:flex;gap:8px}
.inline-editor-btns .btn{padding:7px 14px;font-size:13px}
.add-link-form{background:var(--ib);border:1px solid var(--ibr);border-radius:9px;padding:14px;margin-top:8px}
.add-link-form input{margin-bottom:8px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMELINE PAGE styles
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tl-layout{position:relative;height:100%;overflow:hidden}
.tl-cw{
  position:absolute;top:0;left:0;right:0;bottom:0;
  overflow:hidden;touch-action:none;cursor:grab;user-select:none;
  background:radial-gradient(ellipse at 20% 40%,rgba(124,131,247,.06) 0%,transparent 60%),
             radial-gradient(ellipse at 80% 70%,rgba(39,174,96,.05) 0%,transparent 55%),var(--bg);
}
.tl-cw.grabbing{cursor:grabbing}
.tl-cw canvas{display:block}
.tl-panel{
  position:absolute;right:0;top:0;bottom:0;z-index:50;
  width:240px;background:var(--panel);border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
  transition:transform .28s cubic-bezier(0.4,0,0.2,1);
}
.tl-panel.collapsed{transform:translateX(100%);}
.tl-panel-title{
  padding:12px 14px 9px;font-size:13px;font-weight:700;
  color:var(--accent);border-bottom:1px solid var(--border);
}
.tl-ctrl{padding:11px 13px;border-bottom:1px solid var(--border)}
.tl-offset-row{display:flex;align-items:center;gap:5px;margin-bottom:8px}
.tl-ob{
  width:34px;height:34px;border-radius:7px;border:none;cursor:pointer;
  font-size:15px;font-weight:700;background:var(--ib);color:#a0a8ff;
  touch-action:manipulation;transition:background .15s;flex-shrink:0;
}
.tl-ob:active{background:var(--ibr);transform:scale(.9)}
.tl-ob:disabled{opacity:.4;cursor:not-allowed;transform:none}
.tl-age-val{
  flex:1;text-align:center;font-size:18px;font-weight:700;color:var(--accent);
  background:var(--ib);border:1px solid var(--ibr);border-radius:7px;padding:5px 0;min-width:0;
}
.tl-slider-row{display:flex;align-items:center;gap:8px}
.tl-slider-row input[type=range],#tl-slider{
  flex:1;-webkit-appearance:none;appearance:none;height:5px;
  border-radius:3px;background:var(--ibr);outline:none;cursor:pointer;
}
#tl-slider::-webkit-slider-thumb,.tl-slider-row input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:20px;height:20px;border-radius:50%;
  background:var(--accent);cursor:pointer;border:2px solid var(--panel);
}
.tl-add-area{padding:11px 13px;border-bottom:1px solid var(--border)}
.tl-add-area input{margin-bottom:6px;font-size:13px;padding:7px 10px}
.tl-add-row{display:flex;gap:6px}
.tl-add-row input{flex:1}
.tl-add-row .btn{flex-shrink:0;padding:7px 10px;font-size:13px}
.tl-clist{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:5px 0}
.tl-clist::-webkit-scrollbar{width:3px}
.tl-clist::-webkit-scrollbar-thumb{background:var(--ibr);border-radius:3px}
.tl-ci{display:flex;align-items:center;padding:7px 12px;cursor:pointer;gap:8px;transition:background .1s}
.tl-ci:hover{background:#22263a}
.tl-ci:hover .tl-cedit{color:var(--accent)}
.tl-ci-av{width:28px;height:28px;border-radius:50%;flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.tl-ci-info{flex:1;min-width:0}
.tl-cname{font-size:13px;color:#cdd;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tl-cmeta{font-size:10px;color:var(--muted);margin-top:1px}
.tl-cage{font-size:12px;font-weight:700;background:var(--ib);color:var(--accent);border-radius:10px;padding:2px 8px;flex-shrink:0}
.tl-cage.faded{color:var(--red);background:rgba(231,76,60,.12)}
.tl-cedit{font-size:12px;color:#334;flex-shrink:0;transition:color .15s;cursor:pointer;padding:4px}
.tl-empty{padding:20px 13px;color:var(--muted);font-size:12px;line-height:1.9}
.tl-info{padding:9px 13px;font-size:11px;color:var(--muted);border-top:1px solid var(--border);line-height:1.9}
.tl-info b{color:var(--accent);font-weight:600}
.limit-tag{color:var(--amber)}
.dead-tag{color:var(--red)}

/* Timeline modal */
.tl-modal-overlay{
  display:none;position:absolute;inset:0;background:rgba(0,0,0,.65);
  z-index:500;align-items:flex-end;justify-content:center;
}
.tl-modal-overlay.show{display:flex}
.tl-modal{
  background:var(--panel);border:1px solid var(--ibr);
  border-radius:14px 14px 0 0;padding:22px 20px 28px;
  width:100%;max-width:440px;max-height:88vh;overflow-y:auto;
  box-shadow:0 -8px 32px rgba(0,0,0,.5);
}
.tl-modal h2{font-size:16px;margin-bottom:14px;color:var(--accent)}
.tl-modal label{font-size:12px;color:#888;display:block;margin-bottom:4px}
.tl-modal input[type=text],.tl-modal input[type=number]{margin-bottom:11px;font-size:14px;padding:9px 11px}
.tl-avatar-section{margin-bottom:12px}
.tl-avatar-wrap{display:flex;align-items:center;gap:12px;margin-bottom:6px}
.tl-avatar-preview{
  width:52px;height:52px;border-radius:50%;overflow:hidden;
  background:var(--ib);border:2px solid var(--ibr);
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:700;color:#fff;flex-shrink:0;position:relative;
}
.tl-avatar-preview img{width:100%;height:100%;object-fit:cover}
#tl-avatar-clear-x{
  position:absolute;top:-4px;right:-4px;width:20px;height:20px;border-radius:50%;
  background:var(--red);color:#fff;font-size:14px;line-height:20px;text-align:center;
  cursor:pointer;display:none;box-shadow:0 2px 6px rgba(0,0,0,.4);font-weight:700;
}
.tl-avatar-preview:hover #tl-avatar-clear-x{display:block}
.tl-avatar-btns-col{flex:1}
.tl-avatar-btns{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:6px}
.tl-avatar-btns .btn{font-size:12px;padding:6px 10px}
.tl-url-row{display:flex;gap:6px}
.tl-url-row input{flex:1;font-size:13px;padding:7px 10px;margin-bottom:0}
.tl-url-row .btn{font-size:12px;padding:6px 10px;flex-shrink:0}
.tl-limit-section{
  background:rgba(124,131,247,.06);border:1px solid rgba(124,131,247,.18);
  border-radius:9px;padding:11px 13px;margin-bottom:13px;
}
.tl-limit-section label{font-size:12px;color:#888;display:block;margin-bottom:6px}
.tl-limit-row{display:flex;align-items:center;gap:10px}
.tl-toggle{
  width:36px;height:20px;background:var(--ibr);border-radius:10px;border:none;
  cursor:pointer;position:relative;flex-shrink:0;transition:background .2s;
}
.tl-toggle.on{background:var(--accent)}
.tl-toggle::after{
  content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;
  top:3px;left:3px;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3);
}
.tl-toggle.on::after{left:19px}
#tl-limit-input{width:80px;margin-bottom:0;font-size:14px;padding:7px 10px}
#tl-file-input{display:none}
#char-file-input{display:none}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB & COLLAPSIBLE (shared timeline + map)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tl-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.tl-tab{flex:1;padding:9px 4px;background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
.tl-tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600}
.tl-tab:hover:not(.active){color:#ccd;background:#22263a}
.tl-tab-content{display:flex;flex-direction:column;flex:1;overflow:hidden}
.tl-section{flex-shrink:0}
.tl-section-hdr{display:flex;align-items:center;justify-content:space-between;padding:9px 13px;cursor:pointer;font-size:12px;color:var(--accent);font-weight:600;border-bottom:1px solid var(--border);user-select:none;transition:background .1s}
.tl-section-hdr:hover{background:#22263a}
.tl-section-body{border-bottom:1px solid var(--border)}
.tl-chevron{font-size:11px;color:var(--muted)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.map-layout{position:relative;height:100%;overflow:hidden}
.map-cw{position:absolute;top:0;left:0;right:0;bottom:0;overflow:hidden;touch-action:none;cursor:grab;background:var(--bg)}
.map-cw canvas{display:block;width:100%;height:100%}

/* Toolbar overlay */
.map-toolbar{position:absolute;top:10px;left:10px;display:flex;align-items:center;gap:4px;background:var(--panel);border:1px solid var(--border);border-radius:9px;padding:5px 7px;box-shadow:0 4px 16px rgba(0,0,0,.4);z-index:10}
.map-tb-btn{width:30px;height:30px;border-radius:6px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.map-tb-btn:hover,.map-tb-btn.active{background:rgba(124,131,247,.18);color:var(--accent)}
.map-tb-sep{width:1px;height:20px;background:var(--border);margin:0 2px}
.map-mode-hint{background:rgba(124,131,247,.18);color:var(--accent);font-size:11px;padding:3px 8px;border-radius:12px;white-space:nowrap;margin-left:4px}

/* Popup */
.map-popup{position:absolute;background:var(--panel);border:1px solid var(--ibr);border-radius:10px;padding:12px 14px;min-width:180px;max-width:260px;box-shadow:0 8px 28px rgba(0,0,0,.5);z-index:20}
.map-popup-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.map-popup-title-text{font-size:14px;font-weight:700;color:var(--text)}
.map-popup-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0 2px;line-height:1}
.map-popup-close:hover{color:var(--red)}
.map-popup-desc{font-size:13px;color:#aab;line-height:1.6;margin-bottom:8px;white-space:pre-wrap}
.map-popup-chars{margin-bottom:8px}
.popup-chars-label{font-size:11px;color:#667;margin-bottom:5px}
.popup-char-item{display:flex;align-items:center;gap:7px;padding:3px 0;font-size:13px;color:#cdd}
.popup-char-av{width:22px;height:22px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0}
.map-popup-actions{display:flex;gap:7px;padding-top:8px;border-top:1px solid var(--border)}

/* Panel */
.map-panel{
  position:absolute;right:0;top:0;bottom:0;z-index:50;
  width:240px;background:var(--panel);border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
  transition:transform .28s cubic-bezier(0.4,0,0.2,1);
}
.map-panel.collapsed{transform:translateX(100%);}
.map-panel-hdr{padding:11px 14px;font-size:13px;font-weight:700;color:var(--accent);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;flex-shrink:0}
.map-panel-hdr:hover{background:#22263a}
#map-panel-chevron{font-size:11px;color:var(--muted)}
.map-tab-scroll{overflow-y:auto;-webkit-overflow-scrolling:touch}
.map-tab-scroll::-webkit-scrollbar{width:3px}
.map-tab-scroll::-webkit-scrollbar-thumb{background:var(--ibr);border-radius:3px}

/* Map item list */
.map-item-list{padding:4px 0}
.map-list-item{display:flex;align-items:center;gap:8px;padding:6px 13px;cursor:pointer;transition:background .1s;font-size:13px}
.map-list-item:hover{background:#22263a}
.map-list-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);flex-shrink:0}
.map-list-name{flex:1;color:#cdd;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.map-list-count{font-size:11px;color:var(--muted)}
.map-empty{padding:10px 13px;font-size:12px;color:var(--muted)}

/* Character picker in modal */
.map-char-picker{display:flex;flex-wrap:wrap;gap:7px;padding:6px 0;max-height:180px;overflow-y:auto;margin-bottom:4px}
.char-pick-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px;border-radius:8px;border:2px solid transparent;cursor:pointer;transition:all .15s;width:60px}
.char-pick-item:hover{background:#22263a}
.char-pick-item.selected{border-color:var(--accent);background:rgba(124,131,247,.1)}
.char-pick-av{width:32px;height:32px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0}
.char-pick-name{font-size:11px;color:#cdd;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARACTERS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chars-layout{display:flex;flex-direction:column;height:100%;overflow:hidden;padding:20px 28px}
.chars-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.chars-header h2{font-size:20px;font-weight:700;color:var(--accent);margin:0}
.chars-grid{flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;padding-bottom:20px;align-items:start}
.chars-grid::-webkit-scrollbar{width:4px}
.chars-grid::-webkit-scrollbar-thumb{background:var(--ibr);border-radius:3px}
.chars-empty{grid-column:1/-1;text-align:center;color:var(--muted);font-size:14px;padding:40px 20px}
.char-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;transition:all .18s;user-select:none}
.char-card:hover{border-color:var(--accent);background:#22263a;transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.char-card-av{width:64px;height:64px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:700;color:#fff;flex-shrink:0}
.char-card-name{font-size:15px;font-weight:700;color:#e8eaed;text-align:center}
.char-card-age{font-size:12px;color:var(--accent);background:rgba(124,131,247,.15);padding:3px 10px;border-radius:12px}
.char-card-desc{font-size:12px;color:#889;text-align:center;line-height:1.5;word-wrap:break-word}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIBRARY PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lib-layout{display:flex;height:100%;overflow:hidden}
.lib-sidebar{width:240px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.lib-sidebar-hdr{padding:12px 14px;font-size:13px;font-weight:700;color:var(--accent);border-bottom:1px solid var(--border)}
.lib-sidebar-body{flex:1;overflow-y:auto;padding:12px 14px}
.lib-sidebar-body::-webkit-scrollbar{width:3px}
.lib-sidebar-body::-webkit-scrollbar-thumb{background:var(--ibr);border-radius:2px}

.lib-tag-list{display:flex;flex-direction:column;gap:4px}
.lib-tag-filter{padding:6px 10px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .15s;font-size:13px;background:var(--bg)}
.lib-tag-filter:hover{background:#22263a}
.lib-tag-filter.selected{background:rgba(124,131,247,.18);color:var(--accent);font-weight:600}

.lib-main{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:20px 28px}
.lib-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.lib-header h2{font-size:20px;font-weight:700;color:var(--accent);margin:0}

.lib-grid{flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;padding-bottom:20px;align-items:start}
.lib-grid::-webkit-scrollbar{width:4px}
.lib-grid::-webkit-scrollbar-thumb{background:var(--ibr);border-radius:3px}
.lib-empty{grid-column:1/-1;text-align:center;color:var(--muted);font-size:14px;padding:40px 20px}

.lib-item{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px 16px;cursor:pointer;transition:all .18s;user-select:none}
.lib-item:hover{border-color:var(--accent);background:#22263a;transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.lib-item-content{font-size:14px;line-height:1.7;color:#cdd;margin-bottom:10px;white-space:pre-wrap;word-break:break-word}
.lib-item-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.lib-item-tag{font-size:11px;padding:3px 8px;border-radius:12px;background:rgba(124,131,247,.15);color:var(--accent)}
.lib-item-author{font-size:12px;color:#889;font-style:italic}

.lib-tag-picker{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:var(--bg);border-radius:6px;min-height:40px}
.lib-tag-checkbox{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;cursor:pointer;transition:all .15s;font-size:13px;background:var(--panel);border:1px solid var(--border)}
.lib-tag-checkbox:hover{background:#22263a;border-color:var(--accent)}
.lib-tag-checkbox input[type="checkbox"]{margin:0;cursor:pointer}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLACEHOLDER page (æœªæ¥é¡µé¢)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-placeholder{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  height:100%;color:var(--muted);text-align:center;padding:40px;
}
.page-placeholder .placeholder-icon{font-size:56px;margin-bottom:16px;opacity:.5}
.page-placeholder h2{font-size:20px;font-weight:700;margin-bottom:8px;color:#667}
.page-placeholder p{font-size:14px;line-height:1.8}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Responsive
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){
  #menu-btn{display:block}
  #sidebar{
    position:fixed;left:0;top:0;bottom:0;z-index:200;
    transform:translateX(-100%);  /* Hidden by default on mobile */
  }
  #sidebar.open{transform:translateX(0) !important}  /* Mobile hamburger menu overrides collapsed state */
  #toast{bottom:16px}
  .tl-panel{width:200px}
  .page-home{padding:20px}
  .tl-modal-overlay{position:fixed}
}
@media(min-width:769px){
  #menu-btn{display:none}
  /* Desktop: sidebar uses .collapsed class, not transform:none */
  #sidebar{position:absolute}  /* Keep absolute, allow .collapsed to work */
}
</style>
</head>
<body>

<div id="app">
  <!-- Topbar -->
  <div id="topbar">
    <button id="menu-btn">â˜°</button>
    <div id="topbar-title">æ¬¢è¿æ¬¢è¿~</div>
    <div id="sync-dot" title="åŒæ­¥çŠ¶æ€"></div>
    <button id="lock-btn" onclick="showPwModal()">ğŸ”’ ç¼–è¾‘</button>
  </div>

  <div id="body-row">
    <!-- Left sidebar -->
    <div id="sidebar">
      <div id="sidebar-logo">
        <div style="flex:1">
          ğŸŒ æ¬¢è¿æ¬¢è¿~
          <span style="display:block;font-size:11px;color:var(--muted);font-weight:400;margin-top:2px">å—¯å‘¢å—¯å‘¢</span>
        </div>
        <button id="sidebar-toggle" class="panel-toggle-btn" title="æŠ˜å /å±•å¼€å¯¼èˆªæ ">â—€</button>
      </div>
      <nav id="sidebar-nav">
        <!-- Nav items injected by router -->
      </nav>
      <div id="sidebar-footer">
        åªè¯»æ¨¡å¼ï¼Œç‚¹å‡»å³ä¸Šè§’è§£é”ç¼–è¾‘
      </div>
    </div>

    <div id="sidebar-overlay"></div>
    <button id="sidebar-expand" class="expand-btn-float" title="å±•å¼€å¯¼èˆªæ ">â–¶</button>

    <!-- Main area -->
    <div id="main-content">
      <div id="readonly-banner" class="show">ğŸ‘ åªè¯»æ¨¡å¼ â€” ç‚¹å‡»å³ä¸Šè§’ã€ŒğŸ”’ ç¼–è¾‘ã€è¾“å…¥å¯†ç </div>
      <div id="page-root" style="flex:1;overflow:hidden;display:flex;flex-direction:column"></div>
    </div>
  </div>
</div>

<!-- Password modal -->
<div id="pw-modal">
  <div id="pw-box">
    <h2>ğŸ” è¾“å…¥ç¼–è¾‘å¯†ç </h2>
    <label>å¯†ç </label>
    <input id="pw-input" type="password" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password"/>
    <div id="pw-error">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
    <div class="mbtns" style="justify-content:flex-end;margin-top:4px">
      <button class="btn bn" onclick="closePwModal()">å–æ¶ˆ</button>
      <button class="btn bp" onclick="submitPw()">ç¡®è®¤</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { showToast, initSidebar, closeSidebar } from './core/ui.js';
import { isEditor, tryUnlock, lock, onAuthChange } from './core/auth.js';

// â”€â”€ Router config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// æ·»åŠ æ–°é¡µé¢ï¼šåœ¨è¿™é‡ŒåŠ ä¸€æ¡è®°å½•ï¼Œå¹¶åœ¨ pages/ ç›®å½•ä¸‹å»ºå¯¹åº” .js æ–‡ä»¶
const ROUTES = [
  {
    id: 'home',
    label: 'ğŸ  ä¸»é¡µ',
    icon: 'ğŸ ',
    loader: () => import('./pages/home.js'),
  },
  {
    id: 'characters',
    label: 'ğŸ‘¥ äººç‰©',
    icon: 'ğŸ‘¥',
    loader: () => import('./pages/characters.js'),
  },
  {
    id: 'library',
    label: 'ğŸ“š æ–‡æœ¬åº“',
    icon: 'ğŸ“š',
    loader: () => import('./pages/library.js'),
  },
  {
    id: 'timeline',
    label: 'â± æ—¶é—´è½´',
    icon: 'â±',
    loader: () => import('./pages/timeline.js'),
  },
  {
    id: 'map',
    label: 'ğŸ—º åœ°å›¾',
    icon: 'ğŸ—º',
    loader: () => import('./pages/map.js'),
  },
  // æœªæ¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šé¡µé¢ï¼š
  // { id: 'gallery', label: 'ğŸ–¼ å›¾åº“', icon: 'ğŸ–¼', loader: () => import('./pages/gallery.js'), placeholder: true },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentRoute = null;
let currentModule = null;

// â”€â”€ Build nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildNav() {
  const nav = document.getElementById('sidebar-nav');
  nav.innerHTML = ROUTES.map(r => `
    <div class="nav-item${r.id===currentRoute?.id?' active':''}" data-id="${r.id}">
      <span class="nav-icon">${r.icon}</span>
      <span class="nav-label">${r.label.replace(r.icon,'').trim()}</span>
      ${r.placeholder ? '<span style="font-size:10px;color:#555;margin-left:auto">soon</span>' : ''}
    </div>
  `).join('');
  nav.querySelectorAll('.nav-item').forEach(el => {
    el.addEventListener('click', () => {
      navigate(el.dataset.id);
      closeSidebar();
    });
  });
}

// â”€â”€ Navigate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function navigate(id) {
  const route = ROUTES.find(r => r.id === id) || ROUTES[0];
  if (currentRoute?.id === route.id) return;

  // Unmount current
  if (currentModule?.unmount) currentModule.unmount();

  currentRoute = route;
  currentModule = null;
  buildNav();

  // Update topbar title
  document.getElementById('topbar-title').textContent = route.label;

  // Mount new page
  const root = document.getElementById('page-root');
  root.innerHTML = '';

  if (route.placeholder) {
    root.innerHTML = `
      <div class="page-placeholder">
        <div class="placeholder-icon">${route.icon}</div>
        <h2>${route.label.replace(route.icon,'').trim()}</h2>
        <p>è¿™ä¸ªé¡µé¢æ­£åœ¨å»ºè®¾ä¸­ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p>
      </div>`;
    return;
  }

  try {
    const mod = await route.loader();
    if (!mod) {
      root.innerHTML = `<div class="page-placeholder"><div class="placeholder-icon">${route.icon}</div><h2>é¡µé¢æš‚æœªå®ç°</h2><p>å¯¹åº”çš„ pages/${route.id}.js æ–‡ä»¶å°šä¸å­˜åœ¨ã€‚</p></div>`;
      return;
    }
    currentModule = mod;
    await mod.mount(root);
  } catch(e) {
    console.error(`é¡µé¢ ${route.id} åŠ è½½å¤±è´¥`, e);
    root.innerHTML = `<div class="page-placeholder"><div class="placeholder-icon">âš ï¸</div><h2>åŠ è½½å¤±è´¥</h2><p>${e.message}</p></div>`;
  }
}

// â”€â”€ Auth UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthChange(editor => {
  const btn = document.getElementById('lock-btn');
  const banner = document.getElementById('readonly-banner');
  const footer = document.getElementById('sidebar-footer');
  if (editor) {
    btn.textContent = 'ğŸ”“ ç¼–è¾‘ä¸­';
    btn.classList.add('unlocked');
    banner.classList.remove('show');
    footer.textContent = 'âœ… ç¼–è¾‘æ¨¡å¼å·²è§£é”';
  } else {
    btn.textContent = 'ğŸ”’ ç¼–è¾‘';
    btn.classList.remove('unlocked');
    banner.classList.add('show');
    footer.textContent = 'åªè¯»æ¨¡å¼ï¼Œç‚¹å‡»å³ä¸Šè§’è§£é”ç¼–è¾‘';
  }
});

// â”€â”€ Password modal (global) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showPwModal = function() {
  if (isEditor()) { lock(); return; }
  document.getElementById('pw-input').value = '';
  document.getElementById('pw-error').style.display = 'none';
  document.getElementById('pw-modal').classList.add('show');
  setTimeout(() => document.getElementById('pw-input').focus(), 60);
};
window.closePwModal = function() {
  document.getElementById('pw-modal').classList.remove('show');
};
window.submitPw = function() {
  const pw = document.getElementById('pw-input').value;
  if (tryUnlock(pw)) {
    closePwModal();
    showToast('âœ… å·²è§£é”ç¼–è¾‘æ¨¡å¼');
  } else {
    document.getElementById('pw-error').style.display = 'block';
    document.getElementById('pw-input').value = '';
    document.getElementById('pw-input').focus();
  }
};
document.getElementById('pw-input').addEventListener('keydown', e => {
  if (e.key==='Enter') window.submitPw();
  if (e.key==='Escape') window.closePwModal();
});
document.getElementById('pw-modal').addEventListener('click', e => {
  if (e.target===document.getElementById('pw-modal')) window.closePwModal();
});

// â”€â”€ Left sidebar toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebarPanel() {
  const sb = document.getElementById('sidebar');
  const btn = document.getElementById('sidebar-toggle');
  const expandBtn = document.getElementById('sidebar-expand');
  console.log('[toggleSidebarPanel] sidebar:', sb, 'collapsed before:', sb?.classList.contains('collapsed'));
  const collapsed = sb.classList.toggle('collapsed');
  console.log('[toggleSidebarPanel] collapsed after:', collapsed, 'classList:', sb?.classList.toString());
  btn.textContent = collapsed ? 'â–¶' : 'â—€';
  if (expandBtn) expandBtn.classList.toggle('show', collapsed);
}
document.getElementById('sidebar-toggle')?.addEventListener('click', toggleSidebarPanel);
document.getElementById('sidebar-expand')?.addEventListener('click', toggleSidebarPanel);

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initSidebar();
buildNav();
navigate('home');  // é»˜è®¤è¿›å…¥ä¸»é¡µ
</script>

</body>
</html>
